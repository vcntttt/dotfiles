#!/usr/bin/env bash
# Focus an existing window (by class/title regex) or launch it floating.

set -euo pipefail

if [[ $# -lt 2 ]]; then
  echo "Usage: launch-or-focus-float <window-pattern> <launch-command...>"
  echo "Env: WIDTH (default 1300), HEIGHT (default 900)"
  exit 1
fi

PATTERN="$1"
shift

WIDTH="${WIDTH:-1300}"
HEIGHT="${HEIGHT:-900}"

find_addr() {
  hyprctl clients -j | jq -r --arg p "$PATTERN" '
    .[] |
    select(
      (.class        | test($p; "i")) or
      (.title        | test($p; "i")) or
      (.initialClass | test($p; "i")) or
      (.initialTitle | test($p; "i"))
    ) |
    .address
  ' | head -n1
}

addr="$(find_addr || true)"

if [[ -z "${addr:-}" ]]; then
  cmd_str="$(printf '%q ' "$@")"
  hyprctl dispatch exec "[float; center; size $WIDTH $HEIGHT] ${cmd_str% }"
  for _ in {1..20}; do
    addr="$(find_addr || true)"
    [[ -n "${addr:-}" ]] && break
    sleep 0.05
  done
  if [[ -n "${addr:-}" ]]; then
    hyprctl dispatch focuswindow "address:$addr"
  fi
  exit 0
fi

hyprctl dispatch focuswindow "address:$addr"

floating=$(hyprctl clients -j | jq -r --arg a "$addr" '
  .[] | select(.address==$a) | .floating
' | head -n1)

if [[ "$floating" == "0" || "$floating" == "false" ]]; then
  hyprctl dispatch togglefloating
fi

hyprctl dispatch resizeactive exact "$WIDTH" "$HEIGHT"
hyprctl dispatch centerwindow 1
