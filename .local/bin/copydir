#!/usr/bin/env bash
# Copia el contenido de todos los archivos de texto de la carpeta actual al portapapeles.

set -e

base_dir="$PWD"
tmp_file=$(mktemp)
tmp_files_list=$(mktemp)

filter_mode="all"
declare -a extensions=()
declare -a exclude_files=()
declare -a target_dirs=()

while [[ $# -gt 0 ]]; do
  case $1 in
  -e | --extension)
    filter_mode="extension"
    shift
    while [[ $# -gt 0 && ! "$1" =~ ^- ]]; do
      extensions+=("$1")
      shift
    done
    ;;
  -x | --exclude)
    filter_mode="exclude"
    shift
    while [[ $# -gt 0 && ! "$1" =~ ^- ]]; do
      exclude_files+=("$1")
      shift
    done
    ;;
  -h | --help)
    echo "Uso: copydir [opciones] [CARPETA...]"
    echo ""
    echo "  (sin carpeta)            Usa la carpeta actual"
    echo "  -e, --extension EXT...   Copia solo archivos con extensiones"
    echo "  -x, --exclude FILE...    Excluye archivos específicos"
    exit 0
    ;;
  --)
    shift
    while [[ $# -gt 0 ]]; do
      target_dirs+=("$1")
      shift
    done
    break
    ;;
  *)
    if [[ "$1" == -* ]]; then
      echo "Opción desconocida: $1" >&2
      exit 1
    fi
    target_dirs+=("$1")
    shift
    ;;
  esac
done

is_text_file() {
  local mime
  mime=$(file --brief --mime-type "$1" 2>/dev/null)
  case "$mime" in
  text/* | application/json | application/xml | application/javascript | application/x-sh | inode/x-empty)
    return 0
    ;;
  *) return 1 ;;
  esac
}

should_include_file() {
  local file="$1"
  local name=$(basename "$file")
  local ext="${name##*.}"

  [[ "$name" == ".gitignore" ]] && return 1

  case "$filter_mode" in
  extension)
    for e in "${extensions[@]}"; do
      [[ "$ext" == "$e" ]] && return 0
    done
    return 1
    ;;
  exclude)
    for ex in "${exclude_files[@]}"; do
      [[ "$name" == "$(basename "$ex")" ]] && return 1
    done
    return 0
    ;;
  *) return 0 ;;
  esac
}

if [ ${#target_dirs[@]} -eq 0 ]; then
  target_dirs=(".")
fi

echo "Archivos en la carpeta:" >"$tmp_file"

for dir in "${target_dirs[@]}"; do
  if [ ! -d "$dir" ]; then
    echo "Directorio no encontrado: $dir" >&2
    exit 1
  fi

  (
    cd "$dir"

    if [ -d .git ]; then
      all_files=$(git ls-files --others --cached --exclude-standard)
    else
      all_files=$(find . -type f -not -path "*/.git/*" | sort)
    fi

    while IFS= read -r file; do
      [ -z "$file" ] && continue
      [[ "$file" != /* ]] && file="$PWD/$file"

      if is_text_file "$file" && should_include_file "$file"; then
        rel=$(realpath --relative-to="$base_dir" "$file")
        echo "- $rel" >>"$tmp_file"
        echo "$file" >>"$tmp_files_list"
      fi
    done <<<"$all_files"
  )
done

cat "$tmp_file"

{
  while IFS= read -r file; do
    echo "────────────────────────────────────────────────────"
    echo "Ruta del archivo: $(realpath --relative-to="$base_dir" "$file")"
    echo ""
    cat "$file"
    echo ""
  done <"$tmp_files_list"
} | clipcopy

echo "✅ Contenido de archivos de texto copiado al portapapeles."

rm -f "$tmp_file" "$tmp_files_list"
